<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>トクテン｜正誤判定</title>
  <style>
    :root{
      --ynu-main:#004E9A;
      --ynu-dark:#00396F;
      --ynu-light:#EAF2FB;

      --bg: var(--ynu-light);
      --card:#ffffff;
      --text:#0f172a;

      --ok-bg: rgba(0, 78, 154, 0.10);
      --ok-text: var(--ynu-dark);

      --err-bg: rgba(164, 38, 44, 0.10);
      --err-text: #a4262c;

      --shadow: 0 10px 30px rgba(15, 23, 42, 0.10);
      --radius: 14px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(0,78,154,0.10), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(0,78,154,0.08), transparent 55%),
        var(--bg);
      color: var(--text);
      -webkit-text-size-adjust: 100%;
    }

    .app{
      max-width: 980px;
      margin: 0 auto;
      padding:
        16px
        calc(14px + env(safe-area-inset-right))
        40px
        calc(14px + env(safe-area-inset-left));
    }

    /* ▼タイトル左キワキワ対策：左右パディング増 + SafeArea対応 */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      margin: 0;
      padding:
        12px
        calc(18px + env(safe-area-inset-right))
        12px
        calc(18px + env(safe-area-inset-left));
      backdrop-filter: blur(10px);
      background: rgba(234, 242, 251, 0.75);
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }
    .topbar-inner{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      align-items:center;
    }
    .pagetitle{
      margin:0;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: 0.02em;
      line-height: 1.2;
    }

    .panel{
      background: var(--card);
      border: 1px solid rgba(15, 23, 42, 0.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: clip;
    }
    .panel-body{ padding: 18px; }

    .answer-form{
      display:flex;
      gap: 10px;
      align-items: stretch;
      margin-bottom: 14px;
    }
    .answer-form input[type="text"]{
      flex:1;
      min-width:0;
      padding: 12px 14px;
      border: 1px solid rgba(15, 23, 42, 0.14);
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      background: #fff;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }
    .answer-form input[type="text"]:focus{
      border-color: rgba(0, 78, 154, 0.45);
      box-shadow: 0 0 0 4px rgba(0, 78, 154, 0.12);
    }

    .answer-form input[type="text"].errorflash{
      border-color: rgba(164, 38, 44, 0.65) !important;
      box-shadow: 0 0 0 4px rgba(164, 38, 44, 0.16) !important;
    }

    .answer-form.shake{
      animation: shake 260ms ease-in-out;
    }
    @keyframes shake{
      0% { transform: translateX(0); }
      20%{ transform: translateX(-6px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-4px); }
      80%{ transform: translateX(4px); }
      100%{ transform: translateX(0); }
    }

    .answer-form button{
      padding: 12px 16px;
      border: 1px solid rgba(0, 78, 154, 0.25);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(0,78,154,0.95), rgba(0,57,111,0.95));
      color: #fff;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      transition: transform 80ms ease, filter 120ms ease;
      white-space: nowrap;
    }
    .answer-form button:hover{ filter: brightness(1.03); }
    .answer-form button:active{ transform: translateY(1px); }

    .message{
      margin-bottom: 18px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      font-size: 13px;
      line-height: 1.4;
      display:none;
      animation: msgPop 180ms ease-out;
    }
    @keyframes msgPop{
      0% { transform: translateY(2px); opacity: 0.7; }
      100% { transform: translateY(0); opacity: 1; }
    }
    .message.show{ display:block; }
    .message.ok{
      color: var(--ok-text);
      background: var(--ok-bg);
      border-color: rgba(0, 78, 154, 0.18);
    }
    .message.error{
      color: var(--err-text);
      background: var(--err-bg);
      border-color: rgba(164, 38, 44, 0.18);
    }

    .stages{
      display:flex;
      flex-direction: column;
      gap: 14px;
    }

    .stage{
      border: 3px solid var(--accent);
      border-radius: 14px;
      background: rgba(255,255,255,0.95);
      overflow: clip;
    }
    .stage-head{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.10);
      background: var(--accent);
      color: var(--accentText);
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .stage h2{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: 0.02em;
    }
    .stage-meta{
      font-size: 12px;
      white-space: nowrap;
      opacity: 0.92;
      color: var(--accentText);
    }
    .stage-body{ padding: 12px 14px 14px; }

    .answer-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px 10px;
    }
    .answer{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding: 12px 10px;
      background: rgba(15, 23, 42, 0.04);
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 12px;
      font-size: 15px;
      user-select:none;
      min-height: 44px;
      transition: background 120ms ease, border-color 120ms ease, transform 80ms ease;
      position: relative;
    }

    .answer.answered{
      background: color-mix(in srgb, var(--accent) 16%, #ffffff);
      border-color: color-mix(in srgb, var(--accent) 45%, rgba(15,23,42,0.10));
      color: color-mix(in srgb, var(--accent) 55%, #0f172a);
      animation: reveal 180ms ease-out;
    }
    @keyframes reveal{
      0%{ transform: scale(0.98); }
      100%{ transform: scale(1); }
    }

    .answer.flash{
      animation: flash 420ms ease-out;
    }
    @keyframes flash{
      0%   { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
      30%  { box-shadow: 0 0 0 7px color-mix(in srgb, var(--accent) 55%, transparent); }
      100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
    }

    .answer-index{ font-weight: 900; color: rgba(15, 23, 42, 0.70); }
    .answer.answered .answer-index{
      color: color-mix(in srgb, var(--accent) 75%, #0f172a);
    }
    .answer-value{ font-weight: 800; }

    @media (max-width: 720px){
      .panel-body{ padding: 14px; }
      .answer-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .answer-form{ flex-direction: column; }
      .answer-form button{ width: 100%; padding: 14px 16px; font-size: 16px; }
    }
    @media (max-width: 420px){
      .answer-grid{ grid-template-columns: 1fr; }
    }

    /* ▼ヒントボタン：右下→右上寄り、テキスト短縮 */
    .hint-button{
      position: fixed;
      top: calc(64px + env(safe-area-inset-top)); /* topbar下あたり */
      right: calc(16px + env(safe-area-inset-right));
      bottom: auto;
      padding: 12px 18px;
      border-radius: 999px;
      background: #ffb900;
      color: #1f1f1f;
      font-weight: 800;
      font-size: 14px;
      text-decoration: none;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.18);
      transition: transform 140ms ease, box-shadow 140ms ease;
      z-index: 30;
    }
    .hint-button:hover{
      transform: translateY(-2px);
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.22);
    }

    .modal-overlay{
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(6px);
      z-index: 50;
      opacity: 1;
      transition: opacity 180ms ease;
    }

    .modal-overlay.is-hidden{
      opacity: 0;
      pointer-events: none;
    }

    .modal-card{
      max-height: 60svh;
      max-width: 530px;
      overflow: scroll;
      width: 100%;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 20px 55px rgba(15, 23, 42, 0.25);
      padding: 28px 30px;
      color: #0f172a;
      font-size: 15px;
      line-height: 1.6;
    }

    .modal-card h3{
      margin: 0 0 16px;
      font-size: 19px;
      font-weight: 800;
      letter-spacing: 0.01em;
      color: #00396f;
    }

    .modal-card p{
      margin: 0 0 10px;
    }

    .modal-actions{
      display: flex;
      justify-content: flex-end;
      margin-top: 18px;
    }
    .modal-ok{
      padding: 10px 18px;
      border: 1px solid rgba(0, 78, 154, 0.25);
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(0,78,154,0.95), rgba(0,57,111,0.95));
      color: #ffffff;
      font-size: 14px;
      font-weight: 900;
      cursor: pointer;
      transition: transform 80ms ease, filter 120ms ease;
    }
    .modal-ok:hover{ filter: brightness(1.03); }
    .modal-ok:active{ transform: translateY(1px); }

    .post-wrapper{
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    .post-wrapper.is-visible{ display: block; }

    /* ▼押しづらい対策：行としてまとめて余白/サイズ確保 */
    .post-actions{
      display:flex;
      justify-content:center;
      align-items: stretch;
      gap: 12px;
      flex-wrap: wrap;
    }

    .post-x-button{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 22px;   /* 少し大きく */
      border-radius: 999px;
      background: linear-gradient(135deg, #111827, #1f2937);
      color: #ffffff;
      font-size: 15px;
      font-weight: 800;
      text-decoration: none;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.28);
      transition: transform 140ms ease, box-shadow 140ms ease;
      border: none;
      cursor: pointer;
      min-width: 180px;
    }
    .post-x-button:hover{
      transform: translateY(-2px);
      box-shadow: 0 16px 36px rgba(15, 23, 42, 0.3);
    }

    .reset-button{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px; /* 少し大きく */
      border-radius: 999px;
      background: #ffffff;
      color: #111827;
      font-size: 14px;
      font-weight: 900;
      border: 1px solid rgba(15, 23, 42, 0.18);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.14);
      transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease;
      cursor: pointer;
      min-width: 180px;
    }
    .reset-button:hover{
      transform: translateY(-2px);
      box-shadow: 0 16px 36px rgba(15, 23, 42, 0.18);
      background: rgba(15, 23, 42, 0.02);
    }

    @media (max-width: 520px){
      .post-actions{ flex-direction: column; }
      .post-x-button, .reset-button{ width: 100%; min-width: 0; }
    }

    .modal-card .post-x-button{ margin-top: 18px; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <p class="pagetitle">トクテン｜正誤判定</p>
    </div>
  </header>

  <main class="app">
    <section class="panel">
      <div class="panel-body">
        <form id="answer-form" class="answer-form" autocomplete="off">
          <input
            type="text"
            id="answer"
            name="answer"
            placeholder="答えをひらがなで入力"
            inputmode="text"
          />
          <button type="submit">送信</button>
        </form>

        <div id="message" class="message" aria-live="polite"></div>
        <div id="stages" class="stages"></div>

        <div id="post-wrapper" class="post-wrapper">
          <div class="post-actions">
            <a
              id="post-x-button"
              class="post-x-button"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
            >Xでポストする</a>

            <button
              id="reset-progress"
              type="button"
              class="reset-button"
            >進捗をリセット</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="welcome-modal" class="modal-overlay">
    <div class="modal-card">
      <h3>遊び始める前に、<br>以下の内容をよくお読みください。</h3>

      <p>【お詫び】<br>封入されている謎用紙に下記の誤りがございました。<br>お詫びして訂正いたします。<br>謎07<br>最下段に「ハテナに当てはまる漢字1文字が正解」を追加<br>謎09<br>誤）「ハテナに当てはまる漢字1文字が正解」<br>正）「ハテナに当てはまる漢字1文字の単位が正解」</p>
      <p>・改変パネルを切り取り、謎用紙に重ねて解くと、ゲーム中と同じように遊ぶことができます。ぜひお使いください。</p>
      <p>・謎17~20は4分割し、謎19は上の線を山折り、下の線を谷折りしてください。</p>
      <p>・ゲームの性質上、謎18,19は本来の流れで解くことができません。複製を入手した状態だとお考えください。</p>
      <p>・あくまで答えのみの判定となるため、改変の成立のさせ方がわからない場合はヒントをご確認ください。</p>
      
      <div class="modal-actions">
        <button id="welcome-ok" type="button" class="modal-ok">OK</button>
      </div>
    </div>
  </div>

  <div id="congrats-modal" class="modal-overlay is-hidden">
    <div class="modal-card">
      <h3>すべての謎に正解しました！</h3>
      <p>下のボタンから感想をポストすることができます。</p>
      <p>もう一度遊びたい場合は<b>進捗をリセット</b>を押してください。</p>
      <p>このウィンドウはボタン以外をタップすると閉じます。</p>
      <a
        id="modal-post-button"
        class="post-x-button"
        href="#"
        target="_blank"
        rel="noopener noreferrer"
      >Xでポストする</a>
    </div>
  </div>

  <!-- ▼ラベル短縮：ヒントはこちら → ヒント -->
  <a class="hint-button" href="https://whynu4559.github.io/tokuten/hint/" target="_blank" rel="noopener noreferrer">ヒント</a>

  <script>
    const STORAGE_KEY = "scoreJudgeOpened:v3";
    const answerLookup = new Map();
    const stageTitles = ["1pt", "3pt", "5pt", "100pt"];

    const postWrapper = document.getElementById("post-wrapper");
    const welcomeModal = document.getElementById("welcome-modal");
    const congratsModal = document.getElementById("congrats-modal");
    const resetButton = document.getElementById("reset-progress");
    const welcomeOkButton = document.getElementById("welcome-ok");

    const postButtons = Array.from(document.querySelectorAll(".post-x-button"));
    const POST_TEXT = encodeURIComponent("全ての謎を解き明かした！ #トクテン謎");
    const POST_URL = `http://bit.ly/4jeQ6YD`;
    postButtons.forEach(btn => { btn.href = POST_URL; });

    let hasShownCongratsModal = false;
    let openedSetCache = null;

    applyResetParam();

    const stageAccentColors = [
      "#cbced1", // 1pt
      "#9EC5FF", // 3pt
      "#1D4ED8", // 5pt
      "#F2C94C", // 100pt
    ];

    const answerSource = `00\tどーる
01\tあんがい
02\tきち
03\tれっぐ
04\tたる
11\tしいれ
12\tわくせい

05\tけーき
06\tもぎり
07\tいろ
08\tあんごう
09\tくみ
10\tきずぐち
13\tといし
14\tごしっく
15\tとっぷ
16\tようひし
17\tげきど

18\tすみか
19\tたいたにっく
20\tししょく
01\tあけがた
02\tとらうま
03\tおか
05\tるーむ
06\tいかり
07\tいえ
09\tさつ
13\tさてい
14\tしっしん

00\tどろっぷ`;

    function parseAnswers(text) {
      return text
        .trim()
        .split(/\r?\n\s*\r?\n/)
        .map(block => block.split(/\r?\n/).map(line => line.trim()).filter(Boolean))
        .filter(stageLines => stageLines.length > 0)
        .map(stageLines => stageLines.map(line => {
          const parts = line.split("\t");
          const index = (parts[0] || "").trim();
          const answer = (parts[1] || "").trim();
          return { index, answer };
        }));
    }

    function sortByIndex(a, b) {
      const ax = a.index;
      const bx = b.index;

      const aNum = (/^\d+$/.test(ax)) ? Number(ax) : null;
      const bNum = (/^\d+$/.test(bx)) ? Number(bx) : null;

      if (aNum !== null && bNum !== null) return aNum - bNum;
      if (aNum !== null && bNum === null) return -1;
      if (aNum === null && bNum !== null) return 1;

      return String(ax).localeCompare(String(bx), "ja");
    }

    function kataToHira(str) {
      return str.replace(/[\u30A1-\u30F6]/g, ch => {
        return String.fromCharCode(ch.charCodeAt(0) - 0x60);
      });
    }

    function normalizeAnswer(str) {
      return kataToHira(str.trim().replace(/\s+/g, ""));
    }

    function isKanaOnly(str) {
      return /^[ぁ-ゖァ-ヺーゝゞ]+$/.test(str);
    }

    function getInvalidKanaChars(str) {
      const bad = str.match(/[^ぁ-ゖァ-ヺーゝゞ]/g) || [];
      const seen = new Set();
      const uniq = [];
      for (const ch of bad) {
        if (!seen.has(ch)) { seen.add(ch); uniq.push(ch); }
      }
      return uniq;
    }

    function loadOpened() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return new Set();
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return new Set();
        return new Set(arr.map(v => String(v)));
      } catch {
        return new Set();
      }
    }

    function saveOpened(set) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(set))); } catch {}
    }

    function showMessage(text, type = "ok") {
      const el = document.getElementById("message");
      el.textContent = text;
      el.classList.remove("ok", "error", "show");
      el.classList.add(type === "error" ? "error" : "ok");
      el.classList.add("show");
    }

    function hideMessage() {
      const el = document.getElementById("message");
      el.classList.remove("show");
      el.textContent = "";
    }

    function updateStageMeta(section, answeredCount, total) {
      const meta = section.querySelector(".stage-meta");
      if (!meta) return;
      meta.textContent = `正解済み ${answeredCount} / ${total}`;
    }

    function showCongratsModal() {
      if (!congratsModal || hasShownCongratsModal) return;
      congratsModal.classList.remove("is-hidden");
      hasShownCongratsModal = true;
    }

    function updatePostButton() {
      const totalCells = document.querySelectorAll(".answer").length;
      const answeredCells = document.querySelectorAll(".answer.answered").length;
      const allAnswered = totalCells > 0 && answeredCells === totalCells;
      if (postWrapper) {
        postWrapper.classList.toggle("is-visible", allAnswered);
      }
      if (allAnswered) {
        showCongratsModal();
      }
    }

    function applyResetParam() {
      try {
        const params = new URLSearchParams(window.location.search);
        if (params.get("reset") === "true") {
          localStorage.removeItem(STORAGE_KEY);
          params.delete("reset");
          const query = params.toString();
          const newUrl = `${window.location.pathname}${query ? `?${query}` : ""}${window.location.hash}`;
          window.history.replaceState(null, "", newUrl);
          showMessage("正解状態をリセットしました。", "ok");
        }
      } catch (error) {
        console.warn("Failed to process reset parameter", error);
      }
    }

    function resetProgress() {
      try { localStorage.removeItem(STORAGE_KEY); } catch {}
      try {
        const openedSet = loadOpened();
        openedSetCache = openedSet;
        const stages = parseAnswers(answerSource);
        renderStages(stages, openedSet);
        hasShownCongratsModal = false;
        if (congratsModal) congratsModal.classList.add("is-hidden");
        showMessage("正解状態をリセットしました。", "ok");
      } catch (e) {
        console.error(e);
        const params = new URLSearchParams(window.location.search);
        params.set("reset", "true");
        window.location.search = params.toString();
      }
    }

    function setupModalDismiss(modal, { ignoreSelectors = [] } = {}) {
      if (!modal) return;
      const hide = () => modal.classList.add("is-hidden");
      modal.addEventListener("click", hide);
      ignoreSelectors.forEach(selector => {
        modal.querySelectorAll(selector).forEach(element => {
          element.addEventListener("click", event => event.stopPropagation());
        });
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && !modal.classList.contains("is-hidden")) {
          hide();
        }
      }, { passive: true });
    }

    function flashCell(cell) {
      cell.classList.remove("flash");
      void cell.offsetWidth;
      cell.classList.add("flash");
      setTimeout(() => cell.classList.remove("flash"), 520);
    }

    function flashInvalidInput() {
      const form = document.getElementById("answer-form");
      const input = document.getElementById("answer");

      form.classList.remove("shake");
      input.classList.remove("errorflash");
      void form.offsetWidth;
      void input.offsetWidth;

      form.classList.add("shake");
      input.classList.add("errorflash");

      setTimeout(() => {
        form.classList.remove("shake");
        input.classList.remove("errorflash");
      }, 320);
    }

    function pickTextColor(hex) {
      const h = hex.replace("#", "");
      if (h.length !== 6) return "#0f172a";
      const r = parseInt(h.slice(0,2), 16);
      const g = parseInt(h.slice(2,4), 16);
      const b = parseInt(h.slice(4,6), 16);
      const l = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
      return (l < 0.55) ? "#ffffff" : "#0f172a";
    }

    function renderStages(stages, openedSet) {
      const stagesContainer = document.getElementById("stages");
      stagesContainer.innerHTML = "";
      answerLookup.clear();

      stages.forEach((stageAnswers, stageIdx) => {
        const sorted = [...stageAnswers].sort(sortByIndex);

        const section = document.createElement("section");
        section.className = "stage";

        const accent = stageAccentColors[stageIdx] || "#9EC5FF";
        section.style.setProperty("--accent", accent);
        section.style.setProperty("--accentText", pickTextColor(accent));

        const head = document.createElement("div");
        head.className = "stage-head";

        const title = document.createElement("h2");
        title.textContent = stageTitles[stageIdx] || `ステージ${stageIdx + 1}`;

        const meta = document.createElement("div");
        meta.className = "stage-meta";

        head.appendChild(title);
        head.appendChild(meta);
        section.appendChild(head);

        const body = document.createElement("div");
        body.className = "stage-body";

        const grid = document.createElement("div");
        grid.className = "answer-grid";

        let answeredCount = 0;

        sorted.forEach(entry => {
          const cell = document.createElement("div");
          cell.className = "answer";

          const indexSpan = document.createElement("span");
          indexSpan.className = "answer-index";
          indexSpan.textContent = `${entry.index}:`;

          const valueSpan = document.createElement("span");
          valueSpan.className = "answer-value";

          const key = entry.answer;
          const alreadyOpened = openedSet.has(key);

          if (alreadyOpened) {
            valueSpan.textContent = key;
            cell.classList.add("answered");
            answeredCount++;
          } else {
            valueSpan.textContent = "？";
          }

          cell.appendChild(indexSpan);
          cell.appendChild(valueSpan);

          if (!answerLookup.has(key)) answerLookup.set(key, []);
          answerLookup.get(key).push({ valueSpan, cell, section });

          grid.appendChild(cell);
        });

        body.appendChild(grid);
        section.appendChild(body);

        updateStageMeta(section, answeredCount, sorted.length);
        stagesContainer.appendChild(section);
      });

      updatePostButton();
    }

    function handleSubmit(event, openedSet) {
      event.preventDefault();
      hideMessage();

      const input = document.getElementById("answer");
      const raw = input.value;
      const trimmed = raw.trim();

      if (!trimmed) {
        flashInvalidInput();
        showMessage("入力欄に文字列を入力してください。", "error");
        return;
      }

      const compact = trimmed.replace(/\s+/g, "");

      if (!isKanaOnly(compact)) {
        flashInvalidInput();
        const badChars = getInvalidKanaChars(compact);
        const shown = badChars.slice(0, 8).join(" ");
        const suffix = badChars.length > 8 ? " …" : "";
        showMessage(`ひらがな以外の文字が含まれています: ${shown}${suffix}`, "error");
        input.select?.();
        return;
      }

      const keyword = normalizeAnswer(trimmed);

      const matches = answerLookup.get(keyword);
      if (!matches) {
        flashInvalidInput();
        showMessage("不正解です。", "error");
        input.select?.();
        return;
      }

      const wasOpened = openedSet.has(keyword);

      matches.forEach(m => {
        m.valueSpan.textContent = keyword;
        m.cell.classList.add("answered");
        flashCell(m.cell);
      });

      openedSet.add(keyword);
      saveOpened(openedSet);

      const sections = Array.from(new Set(matches.map(m => m.section)));
      sections.forEach(sec => {
        const total = sec.querySelectorAll(".answer").length;
        const answered = sec.querySelectorAll(".answer.answered").length;
        updateStageMeta(sec, answered, total);
      });

      showMessage(wasOpened ? "既に正解済みです" : "正解です！", "ok");
      input.value = "";
      input.focus();

      updatePostButton();
    }

    function hideWelcomeModal() {
      if (!welcomeModal) return;
      welcomeModal.classList.add("is-hidden");
    }

    try {
      const openedSet = loadOpened();
      openedSetCache = openedSet;
      const stages = parseAnswers(answerSource);
      renderStages(stages, openedSet);

      document.getElementById("answer-form")
        .addEventListener("submit", (e) => handleSubmit(e, openedSet));

      if (resetButton) resetButton.addEventListener("click", resetProgress);

      if (welcomeOkButton) {
        welcomeOkButton.addEventListener("click", (e) => {
          e.stopPropagation();
          hideWelcomeModal();
        });
      }

      updatePostButton();
    } catch (error) {
      console.error(error);
      showMessage("答えリストの読み込みに失敗しました。", "error");
    }

    const shouldSkipWelcome = openedSetCache && openedSetCache.size > 0;
    if (welcomeModal && shouldSkipWelcome) {
      welcomeModal.classList.add("is-hidden");
    }

    setupModalDismiss(welcomeModal, { ignoreSelectors: ["#welcome-ok"] });
    setupModalDismiss(congratsModal, { ignoreSelectors: ["#modal-post-button"] });
  </script>
</body>
</html>
